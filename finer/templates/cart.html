{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Shopping Cart</title>

    <link rel="icon" href="{% static 'images/cart.jpg' %}" type="image/jpg" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="{% static 'css/cart.css' %}" />
  </head>

  <body>
    <div class="px-4 px-lg-0">
      <div class="container text-white py-5 text-center">
        <h1 class="display-4">Shopping cart</h1>
      </div>
      <!-- End -->

      <div class="pb-5">
        <div class="container">
          <div class="row">
            <div class="col-lg-12 p-5 bg-white rounded shadow-sm mb-5">
              <!-- Shopping cart table -->
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th scope="col" class="border-0 bg-light">
                        <div class="p-2 px-3 text-uppercase">Product</div>
                      </th>
                      <th scope="col" class="border-0 bg-light">
                        <div class="py-2 text-uppercase">Price</div>
                      </th>
                      <th scope="col" class="border-0 bg-light">
                        <div class="py-2 text-uppercase">Quantity</div>
                      </th>
                      <th scope="col" class="border-0 bg-light">
                        <div class="py-2 text-uppercase">Remove</div>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Render products from the cart -->
                    {% for item in cart_items %}
                    <tr>
                      <th scope="row" class="border-0">
                        <div class="p-2">
                          {% if item.pid.image %}
                          <img
                            src="{{ item.pid.image.url }}"
                            alt=""
                            width="70"
                            class="img-fluid rounded shadow-sm"
                          />
                          {% else %}
                          <p>No image available</p>
                          {% endif %}

                          <div class="ml-3 d-inline-block align-middle">
                            <h5 class="mb-0">
                              <a
                                href="#"
                                class="text-dark d-inline-block align-middle"
                                >{{ item.pid.name }}</a
                              >
                            </h5>
                            <span
                              class="text-muted font-weight-normal font-italic d-block"
                              >Category: {{ item.pid.category }}</span
                            >
                          </div>
                        </div>
                      </th>
                      {% include 'messages.html' %}
                      <td class="border-0 align-middle">
                        <strong>₹{{ item.pid.price }}</strong>
                      </td>
                      <td class="border-0 align-middle">
                        <input
                          type="number"
                          class="form-control quantity-input"
                          value="{{ item.quantity }}"
                          data-product-id="{{ item.pid.id }}"
                        />
                      </td>
                      <td class="border-0 align-middle">
                        <a
                          href="{% url 'remove_from_cart' item.pid.id %}"
                          class="text-dark"
                        >
                          <i class="fa fa-trash"></i>
                        </a>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <!-- End -->
            </div>
          </div>

          <div class="row py-5 p-4 bg-white rounded shadow-sm">
            <div class="col-lg-12">
              <div
                class="bg-light rounded-pill px-4 py-3 text-uppercase font-weight-bold"
              >
                Order summary
              </div>
              <div class="p-4">
                <ul class="list-unstyled mb-4">
                  <li class="d-flex justify-content-between py-3 border-bottom">
                    <strong class="text-muted">Shipping and handling</strong>
                    <strong>Free</strong>
                  </li>
                  <li class="d-flex justify-content-between py-3 border-bottom">
                    <strong class="text-muted">Total</strong>
                    <h5 class="font-weight-bold">₹{{ total_amount }}</h5>
                  </li>
                </ul>
                <a
                  href="{% url 'checkout' total_amount %}"
                  class="btn btn-dark rounded-pill py-2 btn-block"
                  >Proceed to checkout</a
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
    <script>
      $(document).ready(function () {
        // Function to update cart quantity via AJAX
        function updateCartQuantity(product_id, new_quantity, inputElement) {
          $.ajax({
            url: '{% url "update_cart" %}',
            type: "POST",
            data: {
              product_id: product_id,
              quantity: new_quantity,
              csrfmiddlewaretoken: "{{ csrf_token }}",
            },
            dataType: "json",
            success: function (response) {
              if (response.success) {
                // Update the total amount in the order summary
                $("#total-amount").text("₹" + response.total_amount);

                inputElement.val(new_quantity);

                // Refresh the entire page
                location.reload();
              } else {
                // Display an error message or perform error handling
                console.error(
                  "Error updating cart quantity:",
                  response.message
                );
              }
            },
            error: function (xhr, errmsg, err) {
              // Handle AJAX errors
              console.error("AJAX Error:", errmsg);
            },
          });
        }

        // Event listener for quantity change
        $(".quantity-input").on("change", function (event) {
          event.preventDefault();

          var product_id = $(this).data("product-id");
          var new_quantity = parseInt($(this).val());

          // Ensure the minimum quantity is 1
          new_quantity = Math.max(1, new_quantity);

          // Update the cart quantity via AJAX and refresh the entire page
          updateCartQuantity(product_id, new_quantity, $(this));
        });
      });
    </script>
  </body>
</html>
